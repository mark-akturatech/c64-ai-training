# ML for C64 - Appendix H: Supermon Monitor

=======================================

The 6520 is an I/O device which acts as an interface between the
microprocessor and peripherals such as printers, displays, keyboards, etc.
The prime function of the 6520 is to respond to stimulus from each of the two
worlds it is serving.  On the one side, the 6520 is interfacing with
peripherals via two eight-bit bi-directional peripheral data ports.  On the
other side, the device interfaces with the microprocessor through an
eight-bit data bus.  In addition to the lines described above, the 6520
provides four interrupt input/peripheral control lines and the logic
necessary for simple, effective control of peripheral interrupts.


                                     |
                                +---------+ -----------
                                |    |    |/  CONTROL  \
                                |         |\           /
                                |         | -----------
         +---------+ ---------- |         | -----------
         |         |/  8 BIT   \|         |/   8 BIT   \
         |         |\ DATA BUS /|         |\ DATA PORT /  PERIPHERAL
         |  MICRO  | ---------- |         | -----------   DEVICES--
         |PROCESSOR|            |  6520   |               PRINTERS,
         |  650x   | ---------- |         | -----------   DISPLAYS,
         |         |/ CONTROL  \|         |/   8 BIT   \  ETC.
         |         |\          /|         |\ DATA PORT /
         +---------+ ---------- |         | -----------
                                |         | -----------
                                |         |/  CONTROL  \
                                |    |    |\           /
                                +---------+ -----------
                                     |

         Figure I.1


The functional configuration of the 6520 is programmed by the microprocessor
during systems initialization.  Each of the peripheral data lines is
programmed to act as an input or output and each of the four
control/interrupt lines may be programmed for one of four possible control
modes.  This allows a high degree of flexibility in the overall operation of
the interface.


Data Input Register
-------------------

When a microprocessor writes data into the 6520, the data which appears on
the data bus is latched into the Data Input Register.  It is then transferred
into one of six internal register of the 6520.  This assures that the data on
the peripheral output lines will not "glitch," i.e., the output lines will
make smooth transitions from high to low or from low to high and the voltage
will remain stable except when it is going to the opposite polarity.

                                                                        :247:

Control Registers (CRA and CRB)
-------------------------------

Figure I.2 illustrates the bit designation and functions in the Control
Registers.  The Control Registers allow the microprocessor to control the
operation of the interrupt lines (CA1, CA2, CB1, CB2), and peripheral control
lines (CA2, CB2).  A single bit in each register controls the addressing of
the Data Direction Registers (DDRA, DDRB) and the Output Registers (ORA, ORB)
discussed below.  In addition, two bits (bit 6 and 7) are provided in each
control register to indicate the status of the interrupt input lines (CA1,
CA2, CB1, CB2).  These interrupt status bits (/IRQA, /IRQB) are normally
interrogated by the microprocessor during the interrupt service program to
determine the source of an active interrupt.  These are the interrupt lines
which drive the interrupt input (/IRQ, /NMI) of the microprocessor.  The
other bits in CRA and CRB are as described in the discussion of the interface
to the peripheral device


               7      6      5      4      3      2      1      0
            +------+------+------+------+------+------+------+------+
        CRA | IRQ  | IRQ  |    CA2 CONTROL     | DDRA | CA1 CONTROL |
            |  A1  |  A2  |                    |ACCESS|             |
            +------+------+------+------+------+------+------+------+

            +------+------+------+------+------+------+------+------+
        CRB | IRQ  | IRQ  |    CA2 CONTROL     | DDRB | CB1 CONTROL |
            |  B1  |  B2  |                    |ACCESS|             |
            +------+------+------+------+------+------+------+------+

        Figure I.2


The various bits in the control registers will be accessed many times during
a program to allow the processor to enable or disable interrupts, change
operating modes, etc. as required by the peripheral device being controlled.


Data Direction Registers (DDRA, DDRB)
-------------------------------------

The Data Direction Registers allow the processor to program each line in the
8-bit Peripheral I/O port to act as either an input or an output.  Each bit
in DDRA controls the corresponding line in the Peripheral A port and each bit
in DDRB controls the corresponding line in the Peripheral B port.  Placing a
"0" in the Data Direction Register causes the corresponding Peripheral I/O
line to act as an input.  A "1" causes it to act as an output.

The Data Direction Registers are normally programmed only during the system
initialization routine which is performed in response to a Reset signal.
However, the contents of these registers can be altered during system
operation.  This allows very convenient control of some peripheral devices
such as keyboards.


Peripheral Output Registers (ORA, ORB)
--------------------------------------

The Peripheral Output Registers store the output data which appears on the
Peripheral I/O port.  Writing a "0" into a bit in ORA causes the
corresponding line on the Peripheral A port to go low (< 0.4V) if that line
is programmed to act as an output.  A "1" causes the corresponding output to
go high.  The lines of the Peripheral B port are controlled by ORB in the
same manner.

                                                                        :248:

Interrupt Status Control
------------------------

The four interrupt/peripheral control lines (CA1, CA2, CB1, CB2) are
controlled by the Interrupt Status Control (A,B).  This logic interprets the
contents of the corresponding Control Register, detects active transitions on
the interrupt inputs and performs those operations necessary to assure proper
operation of these four peripheral interface lines.


Reset (/RES)
------------

The active low Reset line resets the contents of all 6520 registers to a
logic zero.  This line can be used as a power-on reset or as a master reset
during system operation.


Interrupt Request Line (/IRQA, /IRQB)
-------------------------------------

The active low Interrupt Request lines (/IRQA and /IRQB) act to interrupt the
microprocessor either directly or through external interrupt priority
circuitry.

Each Interrupt Request line has two interrupt flag bits which can cause the
Interrupt Request line to go low.  These flags are bits 6 and 7 in the two
Control Registers.  These flags act as the link between the peripheral
interrupt signals and the microprocessor interrupt inputs.  Each flag has a
corresponding interrupt disable bit which allow the processor to enable or
disable the interrupt from each of the four interrupt inputs (CA1, CA2, CB1,
CB2).

The four interrupt flags are set by active transitions of the signal on the
interrupt input (CA1, CA2, CB1, CB2).  Controlling this active transition is
discussed in the next section.


Control of /IRQA
----------------

Control Register A bit 7 is always set by an active transition of the CA1
interrupt input signal.  Interrupting from this flag can be disabled by
setting bit 0 in the Control Register A (CRA) to a logic 0.  Likewise,
Control Register A bit 6 can be set by an active transition of the CA2
interrupt input signal.  Interrupting from this flag can be disabled by
setting bit 3 in the Control Register to a logic 0.

Both bit 6 and bit 7 in CRA are reset by a "Read Peripheral Output Register
A" operation.  This is defined as an operation in which the processor reads
the Peripheral A I/O port.

                                                                        :249:

Control of /IRQB
----------------

Control of /IRQB is performed in exactly the same manner as that described
above for /IRQA.  Bit 7 in CRB is set by an active transition on CB1;
interrupting from this flag is controlled by CRB bit 0.  Likewise, bit 6 in
CRB is set by an active transition on CB2; interrupting from this flag is
controlled by CRB bit 3.

Also, both bit 6 and bit 7 are reset by a "Read Peripheral B Output Register"
operation.


Summary
-------

/IRQA goes low when CRA-7=1 and CRA-0=1 or when CRA-6=1 and CRA-3=1.

/IRQB goes low when CRB-7=1 and CRB-0=1 or when CRB-6=1 and CRB-3=1.

It should be stressed at this point that the flags act as the link between
the peripheral interrupt signal and the processor interrupt inputs.  The
interrupt disable bits allow the processor to control the interrupt function.


Peripheral I/O Ports
--------------------

Each of the Peripheral I/O lines can be programmed to act as an input or an
output.  This is accomplished by setting a "1" in the corresponding bit in
the Data Direction Register for those lines which are to act as outputs.  A
"0" in a bit of the Data Direction Register causes the corresponding
Peripheral I/O lines to act as an input.


Interrupt Input/Peripheral Control Lines (CA1, CA2, CB1, CB2)
-------------------------------------------------------------

The four interrupt input/peripheral control lines provide a number of special
peripheral control functions.  These lines greatly enhance the power of the
two general purpose interface ports (PA0-PA7, PB0-PB7).


Peripheral A Interrupt Input/Peripheral Control Lines (CA1, CA2)
----------------------------------------------------------------

CA1 is an interrupt input only.  An active transition of the signal on this
input will set bit 7 of the Control Register A to a logic 1.  The active
transition can be programmed by the microprocessor by setting a "0" in bit 1
of the CRA if the interrupt flag (bit 7 of CRA) is to be set on a negative
transition of the CA1 signal or a "1" if it is to be set on a positive
transition.

                                                                        :250:

Setting the interrupt flag will interrupt the processor through /IRQA if bit
0 of CRA is a 1 as described previously.

CA2 can act as a totally independent interrupt input or as a peripheral
control output.  As an input (CRA, bit 5=0) it acts to set the interrupt
flag, bit 6 of CRA, to a logic 1 on the active transition selected by bit 4
of CRA.

These control register bits and interrupt inputs serve the same basic
function as that described above for CA1.  The input signal sets the
interrupt flag which serves as the link between the peripheral device and the
processor interrupt structure.  The interrupt disable bit allows the
processor to exercise control over the system interrupts.

In the Output mode (CRA, bit 51), CA2 can operate independently to generate a
simple pulse each time the microprocessor reads the data on the Peripheral A
I/O port.  This mode is selected by setting CRA, bit 4 to a "0" and CRA, bit
3 to a "1".  This pulse output can be used to control the counters, shift
registers, etc. which make sequential data available on the Peripheral input
lines.

A second output mode allows CA2 to be used in conjunction with CA1 to
"handshake" between the processor and the peripheral device.  On the A side,
this technique allows positive control of data transfers from the peripheral
device into the microprocessor.  The CA1 input signals the processor that
data is available by interrupting the processor.  The processor reads the
data and sets CA2 low.  This signals the peripheral device that it can make
new data available.

The final output mode can be selected by setting bit 4 of CRA to a 1.  In
this mode, CA2 is a simple peripheral control output which can be set high or
low by setting bit 3 of CRA to a 1 or a 0 respectively.


Peripheral B Interrupt Input/Peripheral Control Lines (CB1, CB2)
----------------------------------------------------------------

CB1 operates as an interrupt input only in the same manner as CA1.  Bit 7 of
CRB is set by the active transition selected by bit 0 of CRB.  Likewise, the
CB2 input mode operates exactly the same as the CA2 input modes.  The CB2
output modes, CRB, bit 5=1, differ somewhat from those of CA2.  The pulse
output occurs when the processor writes data into the Peripheral B Output
Register.  Also, the "handshaking" operates on data transfers from the
processor into the peripheral device.

                                                                        :251:

6545-1 CRT Controller (CRTC)
