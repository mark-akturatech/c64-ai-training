# Kick Assembler: Segments (Chapter 10 introduction)

**Summary:** Describes Kick Assembler segments as lists of memory blocks created by the `*=` directive; explains that segments allow reusing the same address ranges in different segments, support modifiers for directing output (e.g., `outPrg`), and maintain a backward-compatible default segment when no block is declared.

**Overview**
A segment in Kick Assembler is a list of memory blocks. Memory blocks are created whenever you use the `*=` directive; each block has a start address, may have an optional name, and can be marked virtual. If you emit code without first defining a memory block, Kick Assembler creates a default memory block for you (backward compatibility).

Segments are used to group these memory blocks and control ordering when outputting binary files. Multiple segments can contain blocks that use the same address ranges (for example, `$1000–$1FFF`) because each segment is treated separately when producing output files.

**Memory Blocks**
- A memory block is generated by using the `*=` directive (sets current origin).
- Each block has:
  - a start address (set with `*=`)
  - an optional name
  - an optional "virtual" flag (blocks may be marked virtual)
- If you add code before any block is defined, a default block is created automatically (the default segment behavior).

Example minimal behavior:
- Using instructions or data implicitly creates/uses the current block.
- You can create multiple blocks that target the same address range in different segments.

**Segments and Ordering**
- A segment is a collection (list) of memory blocks.
- Segments are output in their defined order to the target binary (or file).
- Because segments are separate, the same logical address range can appear in multiple segments (useful for banked code or multiple banks).
- Example: a `.segment BANK4` is used for code that resides in a `$1000–$1FFF` bank; multiple such segments are arranged and output in the correct order.

**Modifiers and Directing Output**
- Segments accept modifiers that control output behavior. The example shows an `outPrg` modifier that directs a segment's output to a named PRG file.
- Example syntax: `.segment File1 [outPrg="MyFile.prg"]`
- Use of such modifiers can place segment output into separate files or otherwise change how segments are emitted.

### Full List of Segment Modifiers
- `BasicUpstart`: Adds a memory block with a BASIC upstart program that points to the given start address. Parameter: `_start` (e.g., `modify="BasicUpstart", _start=$8000`).
- `modify`: Assigns a modifier to the segment (e.g., `modify="BasicUpstart"`).
- `outPrg`: Outputs a PRG file with the content of the segment (e.g., `outPrg="myfile.prg"`).
- `outBin`: Outputs a BIN file with the content of the segment (e.g., `outBin="myfile.bin"`).
- `start`: Sets the start of the default memory block to the given expression (e.g., `start=$1000`).
- `startAfter`: Makes the default memory block start after the given segment (e.g., `startAfter="Code"`).
- `virtual`: Makes all the memory blocks in the segment virtual.
- `align`: Aligns the default memory block to a given page size. Used together with `startAfter` (e.g., `align=$100`).
- `allowOverlap`: Allows overlapping memory blocks.
- `dest`: Sets the destination of the segment (e.g., `dest="1541"`).
- `fill`: Fills unused bytes between `min` and `max` with the fill byte.
- `fillByte`: Sets the value of the fill byte. If not specified, it will be zero (e.g., `fillByte=$88`).
- `hide`: Hides the segments in memory dumps.
- `marg1`, `marg2`, ..., `marg5`: Arguments for a modifier (e.g., `marg1=$1000, marg2="hello"`).
- `max`: Sets the maximum address of the segment (e.g., `max=$cfff`).
- `min`: Sets the minimum address of the segment (e.g., `min=$c000`).
- `prgFiles`: Includes program files as memory blocks (e.g., `prgFiles="data/music.prg, data/charset2x2.prg"`).
- `segments`: Includes memory blocks from other segments (e.g., `segments="Code, Data"`).
- `sidFiles`: Includes the data of a SID file as a memory block (e.g., `sidFiles="music.sid"`).

**Combining Segments and Specifying Order**
- Segments can be combined to form new segments by including memory blocks from other segments using the `segments` parameter.
- The order of segments in the output is determined by the order they are defined or referenced.
- Example: `.file [name="myfile.prg", segments="Code,Data"]` combines the `Code` and `Data` segments into a single output file.

**Virtual Memory Blocks**
- Virtual memory blocks are declared by adding the `virtual` keyword to the `*=` directive.
- Virtual blocks are not saved in the resulting file but can overlap other memory blocks.
- Example:
- In the memory map, virtual blocks are marked with an asterisk:

**Backward Compatibility (Default Segment)**
- If no segments or blocks are explicitly declared, Kick Assembler uses a default block/segment so existing (older) code continues to assemble without modification.

## Source Code

  ```asm
  *=$0400 "Data Tables 1" virtual
  table1: .fill $100,0
  table2: .fill $100,0
  ```

  ```
  Memory Map
  ----------
  *$0400-$05ff Data Tables 1
  ```

```asm
.segment File1 [outPrg="MyFile.prg"]
* = $1000
    lda #$00
    sta $d020
    rts
.segment Default
```

```asm
.segment BANK4
* = $1000
    lda #$01
    sta $d020
    rts
```

```asm
; Implicit default memory block example (no prior *= shown)
inc $D020
jmp *-3
```

```text
; Note:
; "A segment is set up for each bank and they are output in the right order to a binary file.
; The code in the 4 segments is restricted to the address space $1000-$1fff.
; Notice how the same address space can be used multiple times, since the code resides in different segments."
```

## References
- [Kick Assembler Manual: Segments](https://www.theweb.dk/KickAssembler/webhelp/content/ch10s03.html)
- [Kick Assembler Manual: Segment Modifiers](https://www.theweb.dk/KickAssembler/webhelp/content/ch10s13.html)
- [Kick Assembler Manual: List of Segment Parameters](https://www.theweb.dk/KickAssembler/webhelp/content/ch10s17.html)
- [Kick Assembler Manual: Memory Directives](https://theweb.dk/KickAssembler/webhelp/content/ch03s05.html)