# ML for C64 - Appendix I: SID Voices, ADSR, Filters

dimension is doubled in the desired direction (the smallest MOB dot may be up
to 4x standard dot dimension if a MOB is both multi-colored and expanded).


Priority
--------

The priority of each MOB may be individually controlled with respect to the
other displayed information from character or bit map modes.  The priority of
each MOB is set by the corresponding bit (MnDP) of register 27 ($1B) as
follows:


     REG BIT | PRIORITY TO CHARACTER OR BIT MAP DATA
     --------+-----------------------------------------------------------
        0    | Non-transparent MOB data will be displayed (MOB in front)
             |
        1    | Non-transparent MOB data will be displayed only instead of
             | Background #0 or multi-color bit pair 01 (MOB behind)


                         MOB - DISPLAY DATA PRIORITY

                         +------------+------------+
                         |  MnDP = 1  |  MnDP = 0  |
                         +------------+------------+
                         | MOBn       | Foreground |
                         | Foreground | MOBn       |
                         | Background | Background |
                         +------------+------------+


MOB data bits of "0" ("00" in multi-color mode) are transparent, always
permitting any other information to be displayed.

The MOBs have a fixed priority with respect to each other, with MOB0 having
the highest priority and MOB7 the lowest.  When MOB data (except transparent
data) of two MOBs are coincident, the data from the lower number MOB will be
displayed.  MOB vs MOB data is prioritized before priority resolution with
character or bit map data.


Collision Detection
-------------------

Two types of MOB collision (coincidence) are detected, MOB to MOB collision
and MOB to display data collision:

                                                                        :285:

  1)  A collision between two MOBs occurs when non-transparent output data of
      two MOBs are coincident.  Coincidence of MOB transparent areas will not
      generate a collision.  When a collision occurs, the MOB bits (MnM) in
      the MOB-MOB COLLISION register 30 ($1E) will be set to "1" for both
      colliding MOBs.  As a collision between two (or more) MOBs occurs, the
      MOB-MOB collision bit for each collided MOB will be set.  The collision
      bits remain set until a read of the collision register, when all bits
      are automatically cleared.  MOBs collisions are detected even if
      positioned off-screen.

  2)  The second type of collision is a MOB-DATA collision between a MOB and
      foreground display data from the character or bit map modes.  The
      MOB-DATA COLLISION register 31 ($1F) has a bit (MnD) for each MOB which
      is set to "1" when both the MOB and non-background display data are
      coincident.  Again, the coincidence of only transparent data does not
      generate a collision.  For special applications, the display data from
      the 0-1 multicolor bit pair also does not cause a collision.  This
      feature permits their use as background display data without
      interfering with true MOB collisions.  A MOB-DATA collision can occur
      off-screen in the horizontal direction if actual display data has been
      scrolled to an off-screen position (see scrolling).  The MOB-DATA
      COLLISION register also automatically clears when read.

The collision interrupt latches are set whenever the first bit of either
register is set to "1".  Once any collision bit within a register is set
high, subsequent collisions will not set the interrupt latch until that
collision register has been cleared to all "0s" by a read.


MOB Memory Access
-----------------

The data for each MOB is stored in 63 consecutive bytes of memory.  Each
block of MOB data is defined by a MOB pointer, located at the end of the
VIDEO MATRIX.  Only 1000 bytes of the video matrix are used in the normal
display modes, allowing the video matrix locations 1016-1023 (VM base + $3F8
to VM base + $3FF) to be used for MOB pointers 0-7, respectively.  The
eight-bit MOB pointer from the video matrix together with the six bits from
the MOB byte counter (to address 63 bytes) define the entire 14-bit address
field:


    A13 |A12 |A11 |A10 |A09 |A08 |A07 |A06 |A05 |A04 |A03 |A02 |A01 |A00
    ----+----+----+----+----+----+----+----+----+----+----+----+----+----
    MP7 |MP6 |MP5 |MP4 |MP3 |MP2 |MP1 |MP0 |MC5 |MC4 |MC3 |MC2 |MC1 |MC0


Where MPx are the MOB pointer bits from the video matrix and MCx are the
internally generated MOB counter bits.  The MOB pointers are read from the
video matrix at the end of every raster line.  When the Y position register
of a MOB matches the current raster line count, the actual fetches of MOB
data begin.  Internal counters automatically step through the 63 bytes of MOB
data, displaying three bytes on each raster line.

                                                                        :286:

Other Features
--------------


Screen Blanking
---------------

The display screen may be blanked by setting the DEN bit in register 17 ($11)
to a "0".  When the screen is blanked, the entire screen will be filled with
the exterior color as in register 32 ($20).  When blanking is active, only
transparent (Phase 1) memory accesses are required, permitting full processor
utilization of the system bus.  MOB data, however, will be accessed if the
MOBs are not also disabled.  The DEN bit must be set to "1" for normal video
display.


Row/Column Select
-----------------

The normal display consists of 25 rows and 40 characters (or character
regions) per row.  For special display purposes, the display window may be
reduced to 24 rows and 38 characters.  There is no change in the format of
the displayed information, except that characters (bits) adjacent to the
exterior border area will not be covered by the border.  The select bits
operate as follows:


                           | NUMBER         | NUMBER OF
                      RSEL | OF ROWS   CSEL | COLUMNS
                      -----+--------   -----+-----------
                        0  | 24 rows     0  | 38 columns
                        1  | 25 rows     1  | 40 columns


The RSEL bit is in register 17 ($11) and the CSEL bit is in register 22
($16).  For standard display the larger display window is normally used,
while the smaller display window is normally used in conjunction with
scrolling.


Scrolling
---------

The display data may be scrolled up to one entire character space in both the
horizontal and vertical direction.  When used in conjunction with the smaller
display window (above), scrolling can be used to create a smooth panning
motion of display data while updating the system memory only when a new
character row (or column) is required.  Scrolling is also used to center a
fixed display within the display window.


                    BITS    | REGISTER | FUNCTION
                 -----------+----------+--------------------
                 X2, X1, X0 | 22 ($16) | Horizontal Position
                 Y2, Y1, Y0 | 17 ($11) | Vertical Position

                                                                        :287:

Light Pen
---------

The light pen input latches the current screen position into a pair of
registers (LPX, LPY) on a low-going edge.  The X position register 19 ($13)
will contain the 8 MSB of the X position at the time of transition.  Since
the X position is defined by a 512-state counter (9 bits) resolution to 2
horizontal dots is provided.  Similarly, the Y position is latched to its
register 20 ($14) but here 8 bits provide single raster resolution within the
visible display.  The light pen latch may be triggered only once per frame,
and subsequent triggers within the same frame will have no effect.
Therefore, you must take several samples before turning the light pen to the
screen (3 or more samples, average), depending on the characteristics of your
light pen.


Raster Register
---------------

The raster register is a dual-function register.  A read of the raster
register 18 ($12) returns the lower 8 bits of the current raster position
(the MSB--RC8 is located in register 17 ($11)).  The raster register can be
interrogate to implement display changes outside the visible area to prevent
display flicker.  The visible display window is from raster 51 through raster
251 ($033-$0FB).  A write to the raster bits (including RC8) is latched for
use in an internal raster compare.  When the current raster matches the
written value, the raster interrupt latch is set.


Interrupt Register
------------------

The interrupt register shows the status of the four sources of interrupt.  An
interrupt latch in register 25 ($19) is set to "1" when an interrupt source
has generated an interrupt request.  The four sources of interrupt are:


  LATCH | ENABLE |
   BIT  |  BIT   | WHEN SET
  ------+--------+----------------------------------------------------------
   IRST |  ERST  | Set when (raster count) = (stored raster count)
   IMDC |  EMDC  | Set by MOB-DATA collision register (first collision only)
   IMMC |  EMMC  | Set by MOB-MOB collision register (first collision only)
   ILP  |  ELP   | Set by negative transition of LP input (once per frame)
   IRQ  |        | Set high by latch set and enabled (invert of /IRQ output)

                                                                        :288:

To enable an interrupt request to set the /IRQ output to "0", the
corresponding interrupt enable bit in register 26 ($1A) must be set to "1".
Once an interrupt latch has been set, the latch may be cleared only by
writing a "1" to the desired latch in the interrupt register.  This feature
allows selective handling of video interrupts without software required to
"remember" active interrupts.


Dynamic RAM Refresh
-------------------

A dynamic RAM refresh controller is built into the 6566/6567 devices.  Five
8-bit row addresses are refreshed every raster line.  This rate guarantees a
maximum delay of 2.02ms between the refresh of any single row address in a
128 refresh scheme.  (The maximum delay is 3.66ms in a 256 address refresh
scheme.)  This refresh is totally transparent to the system, since the
refresh occurs during Phase 1 of the system clock.  The 6567 generates both
/RAS and /CAS which are normally connected directly to the dynamic RAMs.
/RAS and /CAS are generated for every Phase 2 and every video data access
(including refresh) so that external clock generation is not required.


Reset
-----

The reset bit (RES) in register 22 ($16) is not used for normal operation.
Therefore it should be set to "0" when initializing the video chip.  When set
to a "1", the entire operation of the video chip is suspended, including
video outputs and sync, memory refresh, and system bus access.


Theory of Operation
-------------------

System Interface
----------------

The 6566/6567 video controller devices interact with the system data bus in a
special way.  A 65xx system requires the system buses only during the Phase 2
(clock high) portion of the cycle.  The 6566/6567 devices take advantage of
this feature by normally accessing system memory during the Phase 1 (clock
low) portion of the clock cycle.  Therefore, operations such as character
data fetches and memory refresh are totally transparent to the processor and
do not reduce the processor throughput.  The video chips provide the
interface control signals required to maintain this bus sharing.

                                                                        :289:

The video devices provide the signal AEC (address enable control) which is
used to disable the processor address bus drivers allowing the video device
to access the address bus.  AEC is active low which permits direct connection
to the AEC input of the 65xx family.  The AEC signal is normally activated
during Phase 1 so that processor operation is not affected.  Because of this
bus "sharing," all memory accesses must be completed in 1/2 cycle.  Since the
video chips provide a 1-MHz clock (which must be used as system Phase 2), a
memory cycle is 500ns including address setup, data access, and data setup to
the reading device.

Certain operations of the 6566/6567 require data at a faster rate than
available by reading only during Phase 1 time; specifically, the access of
character pointers from the video matrix and the fetch of MOV data.
Therefore, the processor must be disabled and the data accessed during the
Phase 2 clock.  This is accomplished via the BA (bus available) signal.  The
BA line is normally high but is brought low for the processor to complete any
current memory accesses.  On the fourth Phase 2 after BA low, the AEC signal
line is normally connected to the RDY input of a 65xx processor.  The
character pointer fetches occur every eighth raster line during the display
window and require 40 consecutive Phase 2 accesses to fetch the video matrix
pointers.  The MOB data fetches require 4 memory accesses as follows:


           PHASE |    DATA     | CONDITION
           ------+-------------+-----------------------------------
             1   | MOB Pointer | Every raster
             2   | MOB Byte 1  | Each raster while MOB is displayed
             1   | MOB Byte 2  | Each raster while MOB is displayed
             2   | MOB Byte 3  | Each raster while MOB is displayed


The MOB pointers are fetched every other Phase 1 at the end of each raster
line.  As required, the additional cycles are used for MOB data fetches.
Again, all necessary bus control is provided by the 6566/6567 devices.


Memory Interface
----------------

The two versions of the video interface chip, 6566 and 6567, differ in
address output configurations.  The 6566 has thirteen fully decoded addresses
for direct connection to the system address bus.  The 6567 has multiplexed
addresses for direct connection to 64K dynamic RAMs.  The least significant
address bits, A06-A00, are present on A06-A00 while /RAS is brought low,
while the most significant bits, A13-A08, are present on A05-A00 while /CAS
is brought low.  The pins A11-A07 on the 6567 are static address outputs to
allow direct connection of these bits to a conventional 16K (2Kx8) ROM.  (The
lower order addresses require external latching.)

                                                                        :290:

Register Map
------------

ADDRESS |DB7  |DB6  |DB5  |DB4  |DB3  |DB2  |DB1  |DB0  | Description
