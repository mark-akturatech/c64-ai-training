# CA65 Assembler - Structs and Unions (.ORG, .TAG, Nested Structures, Limitations)


; 6551
.struct ACIA            ; Asynchronous Communications Interface Adapter
        .org    $031C
DATA    .byte
STATUS  .byte
CMD     .byte           ; Command register
CTRL    .byte           ; Control register
.endstruct

        lda     ACIA::DATA      ; Get an RS-232 character
15.5 The .TAG keyword
By using the .TAG keyword, it is possible to reserve space for an already defined struct or union within another struct:

      .struct Point
              xcoord  .word
              ycoord  .word
      .endstruct

      .struct Circle
              Origin  .tag    Point
              Radius  .byte
      .endstruct
Actual space for a struct or union may be allocated by using the .TAG directive.

C:      .tag    Circle
Members are just offsets from the start of the struct or union. To access a field of a struct, the member offset must be added to the address of the struct variable itself:

        lda    C + Circle::Radius                    ; Load circle radius
        lda    C + Circle::Origin + Point::ycoord    ; Load circle origin.ycoord
Nested structures or unions are treated differently depending on whether they are anonymous. If named, a new structure definition is created within the enclosing scope, with its offsets beginning at 0. If anonymous, the members of the new structure are added to the enclosing scope instead, with offsets continuing through that scope. Example:


      .struct Object
              id .byte                ; Object::id = 0
              target .struct Point    ; Object::target = 1
                      xcoord  .word   ; Object::Point::xcoord = 0
                      ycoord  .word   ; Object::Point::ycoord = 2
              .endstruct
               cost .struct           ; Object::cost = 5
                      price  .word    ; Object::price = 5
                      tax  .word      ; Object::tax = 7
              .endstruct
              .struct
                      radius  .word   ; Object::radius = 9
              .endstruct
      .endstruct

O:    .tag   Object
      lda    O + Object::target + Object::Point::ycoord  ; Named struct
      lda    O + Object::tax                             ; Anonymous
      lda    O + Object::radius                          ; Anonymous

      ; Be careful not to use a named nested structure without also adding the
      ; offset to the nested structure itself.
      lda    O + Object::Point::ycoord                   ; Incorrect!
      lda    O + Object::target + Object::Point::ycoord  ; Correct
In this example, the first nested structure is named "Point", and its member offsets begin at 0. On the other hand, the two anonymous structures simply continue to add members to the enclosing "Object" structure.

Note that an anonymous structure does not need a member name, since all of its members become part of the enclosing structure. The "cost" member in the example is redundantly the same offset as its first member "price".

15.6 Limitations
Structs and unions currently are implemented as nested symbol tables (in fact, they were a by-product of the improved scoping rules). Currently, the assembler has no idea of types. That means that the .TAG keyword only will allocate space. You won't be able to initialize variables declared with .TAG; and, adding an embedded structure to another structure with .TAG will not make that added structure accessible by using the '::' operator.

