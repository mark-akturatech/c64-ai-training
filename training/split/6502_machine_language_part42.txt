# ML for C64 - Appendix I: VIC-II Chip Reference

======================================

The 6522 Versatile Interface Adapter (VIA) provides two peripheral ports with
input latching, two powerful interval timers, and a
serial-to-parallel/parallel-to-serial shift register.


Register Map
------------

              +---------+---------------------------+----------+
              | ADDRESS |        DESCRIPTION        | REGISTER |
              +---------+---------------------------+----------+
              |  $9110  | Port B                    | AAAAAAAA |
              |  $9111  | Port A (with handshaking) | BBBBBBBB |
              |  $9112  | Data Direction B          | CCCCCCCC |
              |  $9113  | Data Direction A          | DDDDDDDD |
              |  $9114  | Timer 1 (L)               | EEEEEEEE |
              |  $9115  | Timer 1 (H)               | FFFFFFFF |
              |  $9116  | Timer 1 latch (L)         | GGGGGGGG |
              |  $9117  | Timer 1 latch (H)         | HHHHHHHH |
              |  $9118  | Timer 2 (L)               | IIIIIIII |
              |  $9119  | Timer 2 (H)               | JJJJJJJJ |
              |  $911A  | Shift Register            | KKKKKKKK |
              |  $911B  | Auxiliary Control         | LLMNNNOP |
              |  $911C  | Peripheral Control        | QQQRSSST |
              |  $911D  | Interrupt Flags           | UVWXYZab |
              |  $911E  | Interrupt Enable          | cdefghij |
              |  $911F  | Port A (no handshaking)   | kkkkkkkk |
              +---------+---------------------------+----------+

                                                                        :262:

Port B I/O Register
-------------------

These eight bits are connected to the eight pins which make up port B.  Each
pin can be set for either input or output.

Input latching is available on this port.  When latch mode is enabled the
data in the register freezes when the CB1 interrupt flag is set.  The
register stays latched until the interrupt flag is cleared.

Handshaking is available for output from this port.  CB2 will act as a DATA
READY SIGNAL.  This must be controlled by the user program.  CB1 acts as the
DATA ACCEPTED signal, and must be controlled by the device connected to the
port.  When DATA ACCEPTED is sent to the 6522, the DATA READY line is
cleared, and the interrupt flag is set.


Port A I/O Register
-------------------

These eight bits are connected to the eight pins which make up port A.  Each
pin can be set for either input or output.  Handshaking is available for both
read and write operations.  Write handshaking is similar to that on Port B.
Read handshaking is automatic.  The CA1 input pin acts as a DATA READY
signal.  The CA2 pin (used for output) is used for a DATA ACCEPTED signal.
When a DATA READY signal is received a flag is set.  The chip can be set to
generate an interrupt or the flag can be polled under program control.  The
DATA ACCEPTED signal can either be a pulse or a DC level.  It is set low by
the CPU and cleared by the DATA READY signal.


Data Direction for Port B
-------------------------

This register is used to control whether a particular bit in Port B is used
for input or output.  Each bit of the data direction register (DDR) is
associated with a bit of Port B.  If a bit in the DDR is set to 1, the
corresponding bit of the port will be an OUTPUT.  If a bit in the DDR is 0,
the corresponding bit of the port will be an INPUT.

For example, if the DDR is set to 7, Port B will be set up as follows:

                    BIT NUMBER     DDR    PORT B FUNCTION
                        0           1         OUTPUT
                        1           1         OUTPUT
                        2           1         OUTPUT
                        3           0          INPUT
                        4           0          INPUT
                        5           0          INPUT
                        6           0          INPUT
                        7           0          INPUT

                                                                        :263:

Data Direction Register for Port A
----------------------------------

This is similar to the DDR for Port B, except that it works on Port A.


E, F, G, H:  Timer Controls
---------------------------

There are two timers on the 6522 chip.  The timers can be set to count down
automatically or count pulses received by the VIA.  The mode of operation is
selected by the Auxiliary Control register.

Timer T1 on the 6522 consists of two 8-bit latches and a 16-bit counter.  The
various modes of the Timer are selected by setting the AUXILIARY CONTROL
REGISTER (ACR).  The latches are used to store a 16-bit data word to load
into the counter.  Loading a number into the latches does not affect the
count in progress.

After it is set, the counter will begin decrementing at 1MHz.  When the
counter reaches zero, an interrupt flag will be set, and the IRQ will go low.
Depending on how the Timer is set, either further interrupts will be
disabled, or it will automatically load the two latches into the counter and
continue counting.  The Timer can also be set to invert the output signal on
a peripheral pin each time it reaches zero and resets.

The Timer locations work differently on reading and writing.


Writing to the Timer
--------------------

E:  Write into the low order latch.  This latch can be loaded into the low
byte of the 16-bit counter.

F:  Write into the high order latch, write into the high order counter,
transfer low order latch into low order counter, and reset the Timer T1
interrupt flag.  In other words, when this location is set the counter is
loaded.

G:  Same as E.

H:  Write into the high order latch and reset the Timer T1 interrupt flag.


Read Timer T1
-------------

E:  Read the Timer T1 low order counter and reset the Timer T1 interrupt
flag.

F:  Read the Timer T1 high order counter.

G:  Read the Timer T1 low order latch.

H:  Read the Timer T1 high order latch.

                                                                        :264:

Timer T2
--------

This Timer operates as an interval timer (in one-shot mode), or as a counter
for counting negative pulses on Port B pin 6.  A bit in the ACR selects which
mode Timer T2 is in.


Writing to Timer T2
-------------------

I:  Write Timer T2 low order byte of latch

J:  Write Timer T2 high order counter byte, transfer low order latch to low
order counter, clear Timer T2 interrupt flag.


Reading Timer T2
----------------

I:  Read Timer T2 low order counter byte, and clear Timer T2 interrupt flag.


K:  Shift Register
------------------

A shift register is a register which will rotate itself through the CB2 pin.
The shift register can be loaded with any 8-bit pattern which can be shifted
out through the CB1 pin, or input to the CB1 pin can be shifted into the
shift register and then read.  This makes it highly useful for serial to
parallel and parallel to serial conversions.

The shift register is controlled by bits 2-4 of the Auxiliary Control
Register.


L, M, N, O, P:  Auxiliary Control Register
------------------------------------------


L:  Timer 1 Control
-------------------

Bit 7  Bit 6
  0      0    One-shot mode (output to PB7 disabled)
  0      1    Free running mode (output to PB7 disabled)
  1      0    One-shot mode (output to PB7 enabled)
  1      1    Free running mode (output to PB7 enabled)


M:  Timer 2 Control
-------------------

Timer 2 has 2 modes.  If this bit is 0, Timer 2 acts as an interval timer in
one-shot mode.  If this bit is 1, Timer 2 will count a predetermined number
of pulses on pin PB6.

                                                                        :265:

N:  Shift Register Control
--------------------------

Bit 4  Bit 3  Bit 2
  0      0      0    Shift Register disabled
  0      0      1    Shift in (from CB1) under control of Timer 2
  0      1      0    Shift in under control of system clock pulses
  0      1      1    Shift in under control of external clock pulses
  1      0      0    Free run mode at rate set by Timer 2
  1      0      1    Shift out under control of Timer 2
  1      1      0    Shift out under control of system clock pulses
  1      1      1    Shift out under control of external clock pulses
         

O:  Port B Latch Enable
-----------------------

As long as this bit is 0, the Port B register will directly reflect the data
on the pins.

If this bit is set to one, the data present on the input pins of Port A will
be latched within the chip when the CB1 INTERRUPT FLAG is set.  As long as
the CB1 INTERRUPT FLAG is set, the data on the pins can change without
affecting the contents of the Port B register.  Note that the CPU always
reads the register (the latches) rather than the pins.

Input latching can be used with any of the input or output modes available
for CB2.


P:  Port A Latch Enable
-----------------------

As long as this bit is 0, the Port A register will directly reflect the data
on the pins.

If this bit is set to one, the data present on the input pins of Port A will
be latched within the chip when the CA1 INTERRUPT FLAG is set.  As long as
the CA1 INTERRUPT FLAG is set, the data on the pins can change without
affecting the contents of the Port A register.  Note that the CPU always
reads the register (the latches) rather than the pins.

Input latching can be used with any of the input or output modes available
for CA2.

                                                                        :266:

Q, R, S, T:  The Peripheral Control Register
--------------------------------------------


Q:  CB2 Control
---------------

Bit 7  Bit 6  Bit 5
  0      0      0    Interrupt Input Mode
  0      0      1    Independent Interrupt Input Mode
  0      1      0    Input Mode
  0      1      1    Independent Input Mode
  1      0      0    Handshake Output Mode
  1      0      1    Pulse Output Mode
  1      1      0    Manual Output Mode (CB2 is held LOW)
  1      1      1    Manual Output Mode (CB2 is held HIGH)


Interrupt Input Mode
--------------------

The CB2 interrupt flag (IFR bit 3) will be set on a negative (high-to-low)
transition on the CB2 input line.  The CB2 interrupt bit will be cleared on a
read or write to Port B.


Independent Interrupt Input Mode
--------------------------------

As above, the CB2 interrupt flag will be set on a negative transition on the
CB2 input line.  However, reading or writing to Port B does not clear the
flag.


Input Mode
----------

The CB2 interrupt flag (IFR bit 3) will be set on a positive (low-to-high)
transition of the CB2 line.  The CB2 flag will be cleared on a read or write
of Port B.


Independent Input Mode
----------------------

As above, the CB2 interrupt flag will be set on a positive transition on the
CB2 line.  However, reading or writing Port B does not affect the flag.


Handshake Output Mode
---------------------

The CB2 line will be set low on a write to Port B.  It will be reset high
again when there is an active transition on the CB1 line.


Pulse Output Mode
-----------------

The CB2 line is set low for one cycle after a write to Port B.

                                                                        :267:

Manual Output Mode
------------------

