# NMOS 6510 - SHX examples and raster-beam sync tricks: using SHX to create a stable synchronization point (remove cycle variance) for raster effects by exploiting &{H+1} masking behavior and RDY induced dropoffs. Includes several code snippets illustrating how to detect a cycle where &{H+1} drops and use it to align to an exact horizontal cycle.

Now as long as we have the &H+1 in play when executing the SHX, the value stored to $A0 will
be $01 (since H+1=$01 and X=$B5). When the &H+1 does not occur, the full value $B5 is
written to $A0, which is read in the next loop iteration, effectively ending the whole loop ($B5 ->
Accu sets the N-flag!).
This syncing approach works just like the variant above: when a badline pauses the CPU on the 4 th
SHX cycle, value $B5 is written to $A0, so the cycle when this happens is known, and
consequently also the cycle position off the loop’s end.

- 54 -

SHY (A11, SYA, SAY, TEY)

Type: Combinations of STA/STX/STY
Opc.
$9C

Mnemonic
SHY abs, x

Function

Size

{addr} = Y & {H+1}

3

Cycles N V - B D I Z C
5

Operation: AND Y register with the high byte of the target address of the argument + 1. Store the
result in memory.
Instabilities:
• The value written is ANDed with &{H+1}, except when the RDY line goes low in the 4 th
cycle.
• When adding X to the target address causes a page boundary crossing, the highbyte of the
target address is incremented by one (as expected), and then ANDed with Y.

Example:
SHY $7700,X

;9C 00 77

Equivalent Instructions:
PHP
PHA
TYA
AND #$78
STA $7700,X
PLA
PLP

; save flags and accumulator
; High byte of Address + 1
; restore flags and accumulator

Note: the SHY opcode would not use the stack.
Test code:
• general: CPU/asap/cpu_shx.prg, Lorenz-2.15/shyax.prg
• &{H+1} drop off: CPU/shxy/shyx2.prg, CPU/shxy/shyx3.prg,
CPU/shxy/shyx4.prg
• page boundaries: CPU/shxy/shyx1.prg, CPU/shxy/shyx5.prg

- 55 -

Example: STY abs, x

When using $FE00 as address, the value stored would be ANDed by $FF and the SHY turns into
a STY:
SHY $FE00,X

---
Additional information can be found by searching:
- "shx_opcode" which expands on instabilities that enable the sync trick
