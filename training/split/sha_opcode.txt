# NMOS 6510 - SHA (AXA/AHX/TEA) opcodes: SHA (zp),y ($93) and SHA abs,y ($9F). Operation: store (A & X & {H+1}) into memory. Instabilities: &{H+1} masking may drop off if RDY goes low during specific cycles; page-boundary crossing will increment high byte then AND it with (A & X). Includes examples, equivalent instruction sequences to emulate SHA (using PHP/PHA/AND/TAX/PLP), and test references.

PLP

; save flags and accumulator
; hack which is needed because there is
; no 'AND-WITH-X' instruction
; High-byte of Address + 1
; restore X-register
; restore flags and accumulator

Note: Memory location $02 would not be altered by the SHA opcode and it would not use the
stack.
Test code:
• general: Lorenz-2.15/shaay.prg, Lorenz-2.15/shaiy.prg
• &{H+1} drop off: CPU/sha/shazpy2.prg CPU/sha/shazpy3.prg
CPU/sha/shaabsy2.prg CPU/sha/shaabsy3.prg CPU/sha/shazpy4.prg
CPU/sha/shaabsy4.prg
• page boundaries: CPU/sha/shazpy1.prg CPU/sha/shaabsy1.prg
CPU/sha/shazpy5.prg CPU/sha/shaabsy5.prg

- 50 -

Example: SAX abs, y

When using $FE00 as address, the value stored would be ANDed by $FF and the SHA turns into a
SAX:
SHA $FE00,Y

; SAX $FE00,Y

Example: SAX (zp), y

When using $FE00 as address, the value stored would be ANDed by $FF and the SHA turns into a
SAX:
LDA #$FE
STA $03
LDA #$00
STA $02
...
SHA ($02),Y

; SAX ($02),Y

- 51 -

SHX (A11, SXA, XAS, TEX)

Type: Combinations of STA/STX/STY
Opc.
$9E

Mnemonic
SHX abs, y

Function

Size

{addr} = X & {H+1}

3

Cycles N V - B D I Z C
5

Operation: AND X register with the high byte of the target address of the argument + 1. Store the
result in memory.
Instabilities:
• The value written is ANDed with &{H+1}, except when the RDY line goes low in the 4 th
cycle.
• When adding Y to the target address causes a page boundary crossing, the highbyte of the
target address is incremented by one (as expected), and then ANDed with X.
Example:
SHX $6430,Y

;9E 30 64

Equivalent Instructions:

---
Additional information can be found by searching:
- "unstable_address_high_byte_group" which expands on group containing SHA opcodes and their instabilities
