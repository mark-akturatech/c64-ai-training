# byRiclianll - Line-range descriptions and commentary for the certify program: explains storing the BAM locally (lines that compensate for a B-A bug), writing worst-case patterns to buffers, block-allocating deallocated tracks/sectors, restoring the BAM, and allocating any bad sectors recorded. Notes alternative PRINT# formats and pointers to later chapters for low-level detail.


180  Calculate  sector  range. 

190  Begin  loop  for  sectors  0  to  sector  range. 

200  Block-free  command. 

210  Counter  to  indicate  number  of  blocks  freed. 

220  Print  track,  sector,  counter. 

250  Close  the  direct-access  channel. 

The  alternate  format  of  the  block-free  command  in  line  200  is: 


PRINT#15, 


B-F 


:  'â– ;0;T;S 


95 


The  opening  and  closing  of  a  direct-access  channel  is  essential  if  the  block-free  command 
is  to  work  correctly.  Experimentation  in  freeing  a  full  diskette  reveals  that  tracks  34 
and  35  still  remain  allocated  if  this  procedure  is  not  followed. 


5.10  Memory-Execute  Command  (M-E) 

The  memory-execute  command  is  used  to  execute  any  standard  ROM  routine  or,  at  the 
pinnacle  of  disk  programming,  a  custom  machine  language  program  that  has  been  poked 
into  1541  RAM.  The  format  of  a  memory-execute  command  is: 

SYNTAX : 

PRINT*  file#,    "M-E"  CHR* ( 1 o-byte)  CHR*<hi- 
byte) 

ALTERNATE: 

PRINT*  fileH^f    "M-E:"  CHR*  <  1  o-byte)   CHR*  (hi - 
byte) 

EXAMPLE: 

PRINT#15, "M-E"CHR* (O) CHR*  <6) 


where 

file#  =  the  logical  file  number  of  the  command  channel 

lo-byte  =  lo-byte  of  the  RAM  or  ROM  address 

hi-byte  =  hi-byte  of  the  RAM  or  ROM  address 


Machine  language  programs  are  poked  into  1541  RAM  with  the  memory-write  command. 
The  following  primitive  program  pokes  a  single  RTS  instruction  to  RAM  and  executes  it. 

100  REM  MEMORY-EXECUTE 
110  OPEN  15,8, 15 

120  PRINT*15, "M-W"CHR*<0)CHR*<6)CHR*<1)C 
HR*<96) 

130  PRINT*15, "M-E"CHR*<0)CHR*<6) 
140  CLOSE 15 
150  END 


Line  Range   Description 


120  Write  1  byte  ($60)  to  RAM  at  $0600. 

130  Execute  RTS  at  $0600. 


96 


The  alternate  format  of  the  memory-execute  command  in  line  130  is: 
PRINT#15, "M-E: "CHR*(0)CHR*(6) 

More  sophisticated  coding  is  available  in  Chapter  7.  In  addition,  refer  to  Chapter  9  for 
pertinent  information  about  the  execution  of  standard  ROM  routines. 


5.11  Block-Execute  Command  (B-E) 

The  block-execute  command  is  used  to  execute  a  machine  language  program  that  resides 
on  diskette.  A  sector  is  read  into  a  DOS  buffer  and  executed  in  a  manner  similar  to 
a  LOAD  and  RUN  on  the  C64.  The  format  of  a  block-execute  command  is: 

SYNTAX : 

PRINT#  +ile#,    "B-E";   channel #;  drive#; 

---
Additional information can be found by searching:
- "certify_diskette_program" which expands on maps parts of the program to their functions and rationale
- "block_allocate_notes_and_bam_update" which expands on why storing/restoring BAM is necessary
