# - Commented Commodore 64 KERNAL Disassembly (Magnus Nyman) - Shift/CBM handling and KEYTAB selection. Reads SHFLAG ($028D) to detect simultaneous <SHIFT> and <CBM> presses and compares against last shift pattern (LSTSHF $028E). If MODE ($0291) allows, toggles VIC memory control bit ($D018 EOR #$02) to switch upper/lower case character set. Handles <CTRL> detection by shifting the scanned key number to select an alternate KEYTAB offset, loads the low/high bytes of the appropriate KEYTAB pointer from the keyboard select vectors at $EB79/$EB7A into $F5/$F6, and then jumps back to the decode routine (JMP $EAE0) to produce the final ASCII value.

.,EB48 AD 8D 02 LDA $028D       SHFLAG
.,EB4B C9 03    CMP #$03        <SHIFT> and <CBM> at the same time
.,EB4D D0 15    BNE $EB64       nope
.,EB4F CD 8E 02 CMP $028E       same as LSTSHF
.,EB52 F0 EE    BEQ $EB42       if so, end
.,EB54 AD 91 02 LDA $0291       read MODE, shift key enable flag
.,EB57 30 1D    BMI $EB76       end
.,EB59 AD 18 D0 LDA $D018       VIC memory control register
.,EB5C 49 02    EOR #$02        toggle character set, upper/lower case
.,EB5E 8D 18 D0 STA $D018       and store
.,EB61 4C 76 EB JMP $EB76       process key image
.,EB64 0A       ASL
.,EB65 C9 08    CMP #$08        test <CTRL>
.,EB67 90 02    BCC $EB6B       nope
.,EB69 A9 06    LDA #$06        set offset for ctrl
.,EB6B AA       TAX             to (X)
.,EB6C BD 79 EB LDA $EB79,X     read keyboard select vectors, low byte
.,EB6F 85 F5    STA $F5         store in KEYTAB, decode table vector
.,EB71 BD 7A EB LDA $EB7A,X     read keyboard select vectors, high byte
.,EB74 85 F6    STA $F6         KEYTAB+1
.,EB76 4C E0 EA JMP $EAE0       process key image


---
Additional information can be found by searching:
- "process_key_image_decode_and_buffer" which expands on after selecting KEYTAB vector this jumps back to the decode routine
- "scnkey_keyboard_scan" which expands on sets SHFLAG/SFDX which this code inspects to select tables or toggle VIC
