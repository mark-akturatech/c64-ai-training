# ML for C64 - Appendix J: Disk Operations, Channels


The monitor is always built near the top of memory.  Its entry address can be
determined by checking the TOM (top-of-memory) pointer.  Monitors are
complex, but feel free to ask the monitor to disassemble itself for your
information.

After Supermon is placed, you may load BASIC programs and use the computer
normally.  Supermon will remain until you shut off the power.


  UNICOPY64

A utility for copying files from one disk to another, on a single drive; or
copying from one disk to cassette tape.  The program is written entirely in
machine language, apart from the SYS that starts it up.

Information is copied from the selected files into RAM memory.  When the
output phase begins, the data is then written to disk or tape.


  UNICOPY INST

A BASIC program explaining how to use UNICOPY64.

                                                                        :311:

  UNICOPY LIST
  ]UNICOPY ASSY

An assembly listing of program UNICOPY.  Because UNICOPY is written entirely
in machine language, a number of tasks are performed in the program that are
often more conveniently done in BASIC.  For example, files are opened and
closed by machine language.  This makes the program listing particularly
interesting for students of these techniques.

Assembly listings have a somewhat different appearance from the machine
language programs this book has dealt with.  The most visible difference is
the use of symbolic addresses.  If there is any confusion, concentrate on the
machine language half of the listing; that will clarify what's going on.
Program UNICOPY LIST allows output to the screen or to a Commodore printer.

For cassette tape output, direct calls to the ROM routines are made; that's
usually not a good practice, but there's little choice here.

The program is written in machine language so that the BASIC ROM can be
flipped out, allowing for more memory space in which to copy programs.


  COPY-ALL         - for PET/CBM
  COPY-ALL.64      - for Commodore 64

A utility for copying files from one disk drive to another.  You will find
two SYS commands in the BASIC part of the program:  one to get the directory,
and the other to do the actual copying.

Information is copied from the selected file into a BASIC string that has
been set aside for the purpose.  A similar technique may be found in the
simpler STRING THING.


  CROSS REF        - for PET/CBM
  CROSS REF 64     - for Commodore 64

This program prepares a cross-reference listing for any selected BASIC
program on disk.  It cross-references both line numbers and variables.  It's
a good way to document a BASIC program.

The program uses two table lookup techniques that may be confusing to the
beginning machine language program reader.  First, it classifies all
characters received from BASIC in terms of "type"; this is done with a table
of 256 elements, one for each possible character.  Second, it used a "state
transition table" to record the nature of the job in progress; for example,
after meeting a GOSUB "token," it will expect to receive a line number.

                                                                        :312:

The second SYS in the BASIC program is used to print the line numbers of the
cross-reference.  It employs an efficient binary-to-decimal conversion
technique, which uses decimal mode.


  FACTORS          - for PET/CBM
  FACTORS V64      - for VIC-20, Commodore 64, and PLUS/4

This program finds factors of numbers up to nineteen digits long.  This shows
a powerful feature of machine language as opposed to BASIC:  the size of
numbers is not limited by the language.

The program contains a number of useful techniques worth studying.  First, it
allows decimal input of a number up to 19 digits (a 64-bit or 8-byte binary
number).  Second, to find factors it performs division with remainder.
Finally, to print results, it must convert binary-to-decimal, using the same
decimal mode technique as in CROSS REF.

The program does not try all divisors.  After trying a few initial values (2,
3, and 5), it switches to a "30-counter" technique, trying only multiples of
30 plus 1, 7, 11, 17, 19, 23, and 29.

The machine language program is relocated by BASIC so that it starts at
hexadecimal 1300 regardless of where it was originally loaded.  This was
originally done to allow for the VIC-20's variable start-of-BASIC, which
rambles according to the amount of extra memory fitted.  It turns out to be
useful for studying to have the program in a fixed location; so the PET/CBM
version was also set up in this way.

Students wishing to disassemble FACTORS will find the following information
useful:

[<cheap plug>for a great disassembling experience of C64 programs on the PC,
 try WFDis, available from my web page!</cheap plug> ;)  -wf]

VARIABLES:

  $0349 - number of times a factor divides evenly
  $034A - "equals" or "asterisk" character for formatting
  $034B - zero suppression flag
  $034C - 30-counter
  $0350 to $0357 - value under analysis
  $0358 to $035F - value work area
  $0360 to $0367 - "base" value for 30-counter
  $036C to $0379 - division work area
  $036C to $036F - remainder
  $0370 to $0377 - quotient

                                                                        :313:

PROGRAM:

  $1300 - Main routine, including:
  $1300 - Start, clear work area
  $131D - Get number digits from user
  $1331 - Handle bad input
  $133A - Begin factoring; check non-zero
  $1350 - Try divisors 2, 3, and 5
  $1365 - Try higher divisors
  $13A2 - Print remaining value
  $13BA - Prompt subroutine
  $13C4 - Input and analyze digit
  $140B - Multiply-by-two subroutine
  $1415 - Division subroutine
  $147A - Try a divisor (short)
  $147D - Try a divisor (long)
  $1485 - Check if remainder is zero
  $1492 - Log factor if found
  $14A2 - Check if more to do
  $14B9 - Print value subroutine
  $14D0 - Print factor subroutine
  $1504 - Clear output area
  $1535 - Print a digit with zero suppression
  $1565 - 30-count values:  1, 7, 11, etc.

Even at machine language speeds, this program can take a long time to analyze
large factors and prime numbers.  The RUN/STOP key is active to allow the
user to stop the run.


  PENTOMINOS INST  - instructions
  PENTOMINOS       - BASIC, all machines
  PENTOMINOS PET   - for PET/CBM
  PENTOMINOS V64   - for VIC-20, Commodore 64, and PLUS/4
  PENTOMINOS B128  - boot for B128 system
  +PENTO128        - program for B128
  +XFER            - transfer sequence for B128

A puzzle solving problem.  Pieces are fitted into a selected rectangular
shape "visibly"--in other words, they may be seen on the screen as they are
tried.

The machine language programs follow the logic of the BASIC program
precisely.  The "shape tables" have been rearranged for greater machine
language convenience (each piece is reached by indexing; the index range of 0
to 255 dictates the piece being selected and its rotation).

The machine language program uses no indirect addressing and no subroutines.
That is not necessarily good practice; it is largely a result of writing the
program logic to exactly match the BASIC program.

                                                                        :314:

This program makes use of tables, and is worth studying for that reason.  It
is also useful to examine the close relationship between the BASIC program
and its machine language equivalent, especially starting at line 2000 in
BASIC.

As with FACTORS, the machine language program is relocated by BASIC so that
it starts at hexadecimal 156D (with tables starting at $12FA) regardless of
where it was originally loaded.  Again, this is necessary for the VIC-20 and
proves to be convenient for study purposes on all machines--except the B-128
version, where this relocation does not happen.

Students wishing to disassemble PENTOMINOS will find the following
information useful:

[UTILITIES:

  WFDis - Available from http://fly.to/theflame  ;)  -wf]

VARIABLES:

  $033C - piece number, BASIC variable P
  $033D to $033E - variables W1 and W2, board size
  $033F - P1, number of pieces placed
  $0340 to $034B - U(..) log of pieces placed
  $034C to $0357 - T(..) rotation of piece
  $0358 to $035C - X(..) location of piece
  $035D to $0361 - Y(..) location of piece
  $0362 to $0370 - tables to place a piece
  $037F to $039C - board "edge" table
  $039D to $03D8 - B(..) the board

PROGRAM:

  $156D - Start, BASIC line 1070
  $15A4 - Clear screen, BASIC line 1120
  $15A9 - Clear variables, set up
  $15CC - Find space, BASIC line 2010
  $1600 - Get new piece, BASIC line 2030
  $1609 - Try piece, BASIC line 2060
  $1686 - Put piece in, BASIC line 2120
  $16E0 - Print "Solution", BASIC line 2170
  $1701 - Undraw piece, BASIC line 2190
  $17AB - Rotate piece, BASIC line 2260
  $17BC - Give up on piece, BASIC line 2280
  $17C1 - Look for new piece, BASIC line 2300

The B128 version does not align to the above addresses.  It is written to
illustrate the "boot" loading system needed for that computer.  Programs
whose name begin with a + symbol are loaded by the bootstrap program; do not
try to load them directly.

                                                                        :315:

  STRING THING     - BASIC, for PET/CBM
  STRING THING V64 - BASIC, for VIC-20, Commodore 64
  ]SAMPLE FILE     - for use with STRING THING

A simple machine language program, POKEable directly from BASIC, to
substitute for an INPUT# statement.

INPUT# has several limitations that sometimes make it awkward for use with
files:

  - No more than 80 characters may be read.
  - The comma or colon character will break up input.
  - Leading spaces will disappear.

STRING THING reads everything up to the next RETURN or end of file.  It is
pure BASIC, but POKEs machine language into the cassette buffer area.  It
finds the first variable and uses it as an input buffer.

                                                                        :316:
                                                                        :317:



                                                           Glossary



The numbers in parentheses indicate the chapter in which the word or phrase
is first used.

Absolute Address: (5) An address that can indicate any location in memory.
Accumulator: (3) The A register; the register used for arithmetic.
Address Bus: (1) A bus that signals which part of memory is wanted for the
                 next memory operation.
Address mode: (5) The manner in which  an instruction reaches information
                  within memory.
Address: (1) The identity of a specific location within memory.
Algorithm: (1) A method or procedure to perform a computing task.
Arithmetic shift or rotate: (4) A shift or rotate that usually preserves the
                                sign of a number.
Assembler: (2) A program that assembles or changes source code into object
               code.
Assembly: (1) The process of changing source code into object code.
Assembly code: (1) Also called source code.  A program written in a somewhat
                   human-readable form.  Must be translated ("assembled")
                   before use.

                                                                        :318:

Assembly language: (1) The set of instructions, or language, in which a
                       source program must be written before assembly.
Binary: (1) Something that has two possible states; a number based on digits,
            each of which has two possible states.
Bit: (1) A binary digit; the smallest element of information within a
         computer.
Bootstrap: (6) A program that starts up another program.
Breakpoint: (8) A location where the program will stop so as to allow
                checking for errors.
Bug: (8) An error within a program.
Bus: (1) A collection of wires connecting many devices together.
Byte: (1) Eight bits of information grouped together; the normal measure of
          computer storage.
Calling point: (2) The program location from which a subroutine is called
                   into play; the subroutine will return to the calling point
                   when finished.
Channel: (8) A path connecting the computer to one of its external devices.
Comment: (8) A program element which does not cause the computer to do
             anything, used as advice to the human program reader.
Commutative: (3) A mathematical operation that works both ways, e.g., 3+4
                 gives the same result as 4+3.
Control bus: (1) A bus that signals timing and direction of data flow to the
                 various connected devices.
Data bus: (1) A bus used to transfer data between memory and the
              microprocessor.
Debugging: (8) Testing a program to uncover possible errors.
Decimal: (1) A number system based on a system of ten digits; the "normal"
             numbering system used by humans.
Decrement: (2) To make smaller by a value of one.
Descriptor: (6) A three-byte set of data giving a string's length and its
                location.
Disassembler: (2) A program that changes object code into assembly code.
                  Similar to a LIST in BASIC.
Dynamic string: (6) A string that must be placed into memory after being
                    calculated or received.
Effective address: (2) The address used by the processor to handle data when
                       executing an instruction.  It may differ from the
                       instruction address (or "operand") because of indexing
                       or indirect addressing.
Event flag: (7) A flag that signals that some event has happened.
Execute: (1) To perform an instruction.

                                                                        :319:

File: (8) A collection of data stored on some external device.
Flag: (3) An on/off indicator that signals some condition.
Floating accumulator: (7) A group of memory locations used by BASIC to
                          perform calculations on a number.
Garbage collection: (6) A BASIC process in which active strings are gathered
                        together and inactive strings are discarded.  On some
                        computers this can be quite time consuming.
Increment: (2) To make larger by a value of one.
Index: (2) To change an address by adding the contents of an index register.
Index register: (2) The X or Y register, which may be used for changing
                    effective addresses.
Indirect address: (5) An addressing scheme whereby the instruction contains
                      the location of the actual address to be used; an
                      address of an address.
Instruction: (1) An element of a program that tells the processor what to do.
Interrupt: (1) An event that causes the processor to leave its normal program
               so that some other program takes control, usually temporarily.
Interrupt enable register: (7) A location within an IA chip that determines
                               whether or not a selected event will cause an
                               interrupt.
Interrupt flag: (7) A signal within the IA indicating that a certain event
                    has requested that an interrupt take place.
Interrupt flag register: (7) A location within the IA where interrupt events
                             can be detected and turned off if desired.
Interrupt source: (7) The particular event that caused an interrupt.  Since
